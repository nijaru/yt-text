name: CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    # Allow manual workflow runs
    workflow_dispatch:

permissions:
    contents: read

jobs:
    test:
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version-file: app/go.mod
                  cache: true

            - name: Build
              working-directory: ./app
              run: go build -v ./...

            - name: Test
              working-directory: ./app
              run: go test -v -race ./...

    docker:
        runs-on: ubuntu-latest
        needs: test
        timeout-minutes: 15

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: false
                  load: true
                  tags: yt-text:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Test image
              run: |
                  docker run --rm yt-text:${{ github.sha }} --version
